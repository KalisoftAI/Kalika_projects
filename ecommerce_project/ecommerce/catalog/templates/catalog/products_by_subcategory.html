{% extends 'catalog/base.html' %}
{% load static %}

{% block title %}{{ sub_category }} - {{ main_category }}{% endblock %}

{% block content %}
<script>
function addToCart(itemId) {
    fetch(`/cart/add/${itemId}/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            document.getElementById('cart-item-count').textContent = data.cart_item_count;
        } else {
            alert('Error adding to cart');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding to cart');
    });
}
</script>

<div>
    <h1>{{ sub_category }}</h1>
    <h2>Products in {{ main_category }}</h2>
    {% if products %}
        <div>
            {% for product in products %}
                <div>
                    {% if product.s3_image_url %}
                        <img src="{{ product.s3_image_url }}" alt="{{ product.product_title }}" width="100">
                    {% else %}
                        <div>No Image</div>
                    {% endif %}
                    <h3>{{ product.product_title|truncatechars:35 }}</h3>
                    <p>${{ product.price|floatformat:2 }}</p>
                    <button onclick="addToCart({{ product.item_id }})">Add to Cart</button>
                    <a href="{% url 'catalog:product_detail' item_id=product.item_id %}">View Details</a>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div>
            <h3>No Products Found</h3>
            <p>This subcategory is currently empty. Please check back later.</p>
            <a href="{% url 'catalog:products_by_category' main_category_name=main_category %}">Back to {{ main_category }}</a>
        </div>
    {% endif %}
</div>

{% endblock %}